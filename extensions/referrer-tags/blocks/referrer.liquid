<script>
  const COOKIE_EXPIRY_DAYS = 7;
  const STORE_DOMAIN = window.location.hostname;
  const COOKIE_NAME = 'app_referrer';
  const cartEndpoints = ['add', '/cart/add', '/cart/update', '/cart/change'];
  let cartReferrerSet = false;

  // --- Cookie helpers ---
  function setCookie(name, value, days = COOKIE_EXPIRY_DAYS) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + value + '; expires=' + expires + '; path=/';
  }

  function getCookie(name) {
    return document.cookie.split('; ').reduce((r, v) => {
      const parts = v.split('=');
      return parts[0] === name ? parts[1] : r;
    }, null);
  }

  // --- Save external referrer in cookie ---
  (function saveReferrerToCookie() {
    const ref = document.referrer;
    if (!ref.includes(STORE_DOMAIN) && ref) {
      try {
        const refDomain = new URL(ref).hostname.replace(/^www\./, '');
        setCookie(COOKIE_NAME, refDomain);
        console.log('External referrer domain saved in cookie:', refDomain);
      } catch (e) {
        console.error('Failed to parse referrer URL:', ref);
      }
    }
  })();

  function isCartEndpoint(url) {
    return cartEndpoints.some((endpoint) => url.includes(endpoint));
  }

  async function updateCartAttribute() {
    if (cartReferrerSet) return;
    const referrerCookie = getCookie(COOKIE_NAME);
    if (!referrerCookie) return;
    cartReferrerSet = true;
    try {
      await fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          attributes: {
            referrer: referrerCookie,
          },
        }),
      });
      console.log('Cart referrer attribute set:', referrerCookie);
    } catch (error) {
      console.error('Failed to update cart attribute:', error);
    }
  }

  // --- Intercept cart requests ---
  (function interceptCartActions() {
    const originalFetch = window.fetch;
    window.fetch = function (...args) {
      const [resource] = args;
      const url = typeof resource === 'string' ? resource : resource.url;
      return originalFetch.apply(this, args).then((response) => {
        if (!cartReferrerSet && isCartEndpoint(url)) {
          response
            .clone()
            .json()
            .then(() => {
              setTimeout(updateCartAttribute, 50);
            });
        }
        return response;
      });
    };

    const originalOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function (method, url, ...rest) {
      this._url = url;
      return originalOpen.call(this, method, url, ...rest);
    };

    const originalSend = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.send = function (...args) {
      this.addEventListener('load', function () {
        if (!cartReferrerSet && isCartEndpoint(this._url)) {
          setTimeout(() => {
            try {
              JSON.parse(this.responseText);
              updateCartAttribute();
            } catch {}
          }, 50);
        }
      });
      return originalSend.apply(this, args);
    };
  })();

  document.addEventListener('DOMContentLoaded', () => {
    if (window.location.pathname.includes('/cart')) {
      updateCartAttribute();
    }
  });
</script>

{% schema %}
{
  "name": "Referrer Tags",
  "target": "body",
  "settings": []
}
{% endschema %}
